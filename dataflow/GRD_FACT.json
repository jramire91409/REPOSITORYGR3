{
	"name": "GRD_FACT",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "T_Stage_GLOBALRETAILDYNAMICS",
						"type": "DatasetReference"
					},
					"name": "TSTAGEGRD"
				},
				{
					"dataset": {
						"referenceName": "T_DIM_MEDIO_PAGO",
						"type": "DatasetReference"
					},
					"name": "mediodepago"
				},
				{
					"dataset": {
						"referenceName": "T_DIM_PRODUCTO",
						"type": "DatasetReference"
					},
					"name": "DIMPRODUCTO"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "T_GRD_FACT",
						"type": "DatasetReference"
					},
					"name": "TGRDFACT"
				},
				{
					"dataset": {
						"referenceName": "T_ER_GRD_FACT",
						"type": "DatasetReference"
					},
					"name": "HUERFANOS",
					"rejectedDataLinkedService": {
						"referenceName": "AzureBlobStoragegr3",
						"type": "LinkedServiceReference"
					}
				}
			],
			"transformations": [
				{
					"name": "select1"
				},
				{
					"name": "join1"
				},
				{
					"name": "join2"
				},
				{
					"name": "Modificarfila1"
				},
				{
					"name": "cast1"
				},
				{
					"name": "split1"
				},
				{
					"name": "derivedColumn1"
				}
			],
			"scriptLines": [
				"source(output(",
				"          ID_TRANSACTION as string,",
				"          ID_CUSTOMER as string,",
				"          FEC_TRANSACTION_DATE as string,",
				"          TIM_TRANSACTION_TIME as string,",
				"          PRODUCTCATEGORY as string,",
				"          PRODUCT_SUBCATEGORY as string,",
				"          PRODUCTDETAIL as string,",
				"          TRANSACTIONVAUE as decimal(24,10),",
				"          PAYMENTMETHOD as string,",
				"          CUSTOMERAGE as integer",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> TSTAGEGRD",
				"source(output(",
				"          ID_MEDIO_PAGO as integer,",
				"          TXT_MEDIO_PAGO as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> mediodepago",
				"source(output(",
				"          ID_PRODUCT as integer,",
				"          TXT_PRODUCT as string,",
				"          PRODUCT_CATEFGORY as string,",
				"          PRODUCT_SUB_CATEGORY as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> DIMPRODUCTO",
				"TSTAGEGRD select(mapColumn(",
				"          ID_TRANSACTION,",
				"          ID_CUSTOMER,",
				"          FEC_TRANSACTION_DATE,",
				"          TIM_TRANSACTION_TIME,",
				"          TRANSACTION_VALUE,",
				"          ID_MEDIO_PAGO,",
				"          ID_PRODUCT,",
				"          FECHA_CARGA",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select1",
				"select1, mediodepago join(upper(PAYMENTMETHOD) == upper(TXT_MEDIO_PAGO),",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> join1",
				"join1, DIMPRODUCTO join(upper(PRODUCTDETAIL) == upper(TXT_PRODUCT),",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> join2",
				"split1@LlavesLlenas alterRow(upsertIf(isNull(ID_TRANSACTION)==false())) ~> Modificarfila1",
				"join2 cast(output(",
				"          FEC_TRANSACTION_DATE as date 'dd/MM/yyyy'",
				"     ),",
				"     errors: true) ~> cast1",
				"cast1 split(isNull(mediodepago@ID_MEDIO_PAGO) == false() && isNull(DIMPRODUCTO@ID_PRODUCT)==false(),",
				"     disjoint: false) ~> split1@(LlavesLlenas, HUERFANOS)",
				"split1@HUERFANOS derive(FECHA_CARGA = currentTimestamp()) ~> derivedColumn1",
				"Modificarfila1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          ID_TRANSACTION as string,",
				"          ID_CUSTOMER as string,",
				"          FEC_TRANSACTION_DATE as date,",
				"          TIM_TRANSACTION_TIME as string,",
				"          TRANSACTION_VALUE as decimal(24,10),",
				"          ID_MEDIO_PAGO as integer,",
				"          ID_PRODUCT as integer",
				"     ),",
				"     deletable:false,",
				"     insertable:false,",
				"     updateable:false,",
				"     upsertable:true,",
				"     keys:['ID_TRANSACTION'],",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     mapColumn(",
				"          ID_TRANSACTION,",
				"          ID_CUSTOMER,",
				"          FEC_TRANSACTION_DATE,",
				"          TIM_TRANSACTION_TIME,",
				"          TRANSACTION_VALUE",
				"     )) ~> TGRDFACT",
				"derivedColumn1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          ID_TRANSACTION as string,",
				"          ID_CUSTOMER as string,",
				"          FEC_TRANSACTION_DATE as date,",
				"          TIM_TRANSACTION_TIME as string,",
				"          TRANSACTION_VALUE as decimal(24,10),",
				"          ID_MEDIO_PAGO as integer,",
				"          ID_PRODUCT as integer,",
				"          FECHA_CARGA as string,",
				"          TXT_PRODUCT_H as string,",
				"          TXT_MEDIO_PAGO_H as string",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     mapColumn(",
				"          ID_TRANSACTION,",
				"          ID_CUSTOMER,",
				"          FEC_TRANSACTION_DATE,",
				"          TIM_TRANSACTION_TIME,",
				"          TRANSACTION_VALUE",
				"     )) ~> HUERFANOS"
			]
		}
	}
}